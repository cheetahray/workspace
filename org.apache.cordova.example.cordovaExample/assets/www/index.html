<!DOCTYPE html>
<html>
  <head>
  <title></title>
  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0;" />
    <meta charset="big5">

    <!-- iPad/iPhone specific css below, add after your main css >
    <link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />		
    <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />		
    -->
    <link rel="stylesheet" href="jquery.mobile.min.css">
    <script src="jquery-1.6.4.min.js"></script>
    <script src="jquery.mobile.min.js"></script>

    <!-- If your application is targeting iOS BEFORE 4.0 you MUST put json2.js from http://www.JSON.org/json2.js into your www directory and include it here -->
    <script type="text/javascript" charset="utf-8" src="cordova-1.8.1.js"></script>
    <script type="text/javascript" charset="utf-8" src="barcodescanner.js"></script>
    
    <script type="text/javascript">

    function onBodyLoad()
	{		
		document.addEventListener("deviceready", onDeviceReady, false);

        scanButton = document.getElementById("scan-button");
	}
	
    function onUpdateReady() {
        updateDB();
        querySuccess();
    }
        
    function createDB() {

        if (!localStorage.cRuth)
        {
            localStorage.setItem("cRuth","off");
        }
        if (!localStorage.hAQes)
        {
            localStorage.setItem("hAQes","off");
        }
        if (!localStorage.JAwra)
        {
            localStorage.setItem("JAwra","off");
        }
        if (!localStorage.zaqAQ)
        {
            localStorage.setItem("zaqAQ","off");
        }
        if (!localStorage.cReth)
        {
            localStorage.setItem("cReth","off");
        }
        if (!localStorage.XawrE)
        {
            localStorage.setItem("XawrE","off");
        }
        if (!localStorage.Qeste)
        {
            localStorage.setItem("Qeste","off");
        }
        if (!localStorage.YEChe)
        {
            localStorage.setItem("YEChe","off");
        }
        if (!localStorage.StuFR)
        {
            localStorage.setItem("StuFR","off");
        }
        if (!localStorage.rATre)
        {
            localStorage.setItem("rATre","off");
        }
        if (!localStorage.cEsap)
        {
            localStorage.setItem("cEsap","off");
        }
        if (!localStorage.jUfrE)
        {
            localStorage.setItem("jUfrE","off");
    }
        if (!localStorage.fUspe)
        {
            localStorage.setItem("fUspe","off");
        }
        if (!localStorage.FrAst)
        {
            localStorage.setItem("FrAst","off");
        }
        if (!localStorage.qExet)
        {
            localStorage.setItem("qExet","off");
    }
        if (!localStorage.pHare)
        {
            localStorage.setItem("pHare","off");
    }
        
    }
        
	function updateDB() {
        var setName = $("#qrname").val();
        localStorage.setItem(setName,"on");
    }
        
    function querySuccess() {
        var number = 0;
        var parent = $('#gallery');
        parent.html('<div class="ui-block-a">' + '<img src="images/' +
                    localStorage.getItem("cRuth") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("cRuth"))
        	number++;
        parent.append('<div class="ui-block-b">' + '<img src="images/' +
                    localStorage.getItem("hAQes") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("hAQes"))
        	number++;
        parent.append('<div class="ui-block-c">' + '<img src="images/' +
                      localStorage.getItem("JAwra") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("JAwra"))
        	number++;
        parent.append('<div class="ui-block-d">' + '<img src="images/' +
                      localStorage.getItem("zaqAQ") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("zaqAQ"))
        	number++;
        parent.append('<div class="ui-block-a">' + '<img src="images/' +
                      localStorage.getItem("cReth") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("cReth"))
        	number++;
        parent.append('<div class="ui-block-b">' + '<img src="images/' +
                      localStorage.getItem("XawrE") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("XawrE"))
        	number++;
        parent.append('<div class="ui-block-c">' + '<img src="images/' +
                      localStorage.getItem("Qeste") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("Qeste"))
        	number++;
        parent.append('<div class="ui-block-d">' + '<img src="images/' +
                      localStorage.getItem("YEChe") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("YEChe"))
        	number++;
        parent.append('<div class="ui-block-a">' + '<img src="images/' +
                      localStorage.getItem("StuFR") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("StuFR"))
        	number++;
        parent.append('<div class="ui-block-b">' + '<img src="images/' +
                      localStorage.getItem("rATre") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("rATre"))
        	number++;
        parent.append('<div class="ui-block-c">' + '<img src="images/' +
                      localStorage.getItem("cEsap") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("cEsap"))
        	number++;
        parent.append('<div class="ui-block-d">' + '<img src="images/' +
                      localStorage.getItem("jUfrE") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("jUfrE"))
        	number++;
        parent.append('<div class="ui-block-a">' + '<img src="images/' +
                      localStorage.getItem("fUspe") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("fUspe"))
        	number++;
        parent.append('<div class="ui-block-b">' + '<img src="images/' +
                      localStorage.getItem("FrAst") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("FrAst"))
        	number++;
        parent.append('<div class="ui-block-c">' + '<img src="images/' +
                      localStorage.getItem("qExet") + '.png" height="50" width="50"/></div>');
        if("on" == localStorage.getItem("qExet"))
        	number++;
        if(number >= 11)
        {
        	parent.append('<div class="ui-block-d">' + '<img src="images/' +
                      localStorage.getItem("pHare") + '.png" height="50" width="50"/></div>');
            if("on" == localStorage.getItem("pHare"))
        		number++;
        }
        switch(number)
        {
        	case 11:
        		$.mobile.changePage($('#eleven'));
	        break;
        	case 15:
        		$('#phoneVal').val(localStorage.getItem("phone"));
        		$('#nameVal').val(localStorage.getItem("name"));
        		$('#idVal').val(localStorage.getItem("id"));
        		$.mobile.changePage($('#fifteen'));
        	break;
        	case 16:
        		$('#idVal').val(localStorage.getItem("id"));
                var idVal = $('#idVal').val();
        	    if(idVal == ""){ 
				    $.mobile.changePage($('#fifteen')); 
			    }
        		else {
        		$.mobile.changePage($('#sixteen'));
                }
        	break;
        }
    }
        
    function onDeviceReady()
	{
		createDB();
        querySuccess();
        scanButton.addEventListener("click", clickScan, false);

        $("form").submit( function() {
        	var phoneVal = $('#phoneVal').val();
        	var nameVal = $('#nameVal').val();
        	var idVal = $('#idVal').val();
        	if(phoneVal == ""){ 
				alert("號碼不能空著喔。"); 
			}
			else if(nameVal == ""){ 
				alert("名字不能空著喔。"); 
			}
			else
			{
        		$.ajax({
        			type: 'POST',
        			url:  'http://ftp.daf.org.tw/getNamePhone.php',
        			data: { id : idVal,
        					name : nameVal,
        					phone : phoneVal }, 
        			error: function() {
           				alert("載入網頁錯誤!");
        			},        
        			success: function(data) {
           				//$('#result').html($(data).find('data').text());
           				var rsname = $(data).find('name').text();
           				if("false" != rsname)
           				{
	           				localStorage.setItem("id", $(data).find('id').text());
	           				localStorage.setItem("name", nameVal);
	           				localStorage.setItem("phone", phoneVal);
	           			}
	           			alert("成功: " + rsname);
	           			$.mobile.changePage($('#home'));    
        			} 
      			});
      		}    
      		return false;
   		});
   		
   		$('#msg').ajaxError(function(event, request, settings) {
      		$(this).html('載入網頁錯誤: ' + settings.msg + '!');
   		});
   
		$('#takePicture').bind("click", function() {
      		takePicture();
   		});
   		$('#selectPicture').bind("click", function() {
      		selectPicture();
   		});
   		$('#uploadPicture').bind("click", function() {
      		uploadPicture();
   		});
   		
	}

    function clickScan() {
        window.plugins.barcodeScanner.scan(scannerSuccess, scannerFailure);
    }

    //------------------------------------------------------------------------------
    function scannerSuccess(result) 
    {
        console.log("scannerSuccess: result: " + result);
        if(false == result.cancelled)
        {
            $('#qrname').val(result.text);
            onUpdateReady();
    	}
        /*
        else
        {
            alert("Ray");
        }
        */
        console.log("We got a barcode\n" +
					"Result: " + result.text + "\n" +
					"Format: " + result.format + "\n" +
					"Cancelled: " + result.cancelled);
    }
	
    //------------------------------------------------------------------------------
    function scannerFailure(message) {
        console.log("scannerFailure: message: " + message);
        //alert("Scanning failed: " + message);
	}
	
	function takePicture() {
	   navigator.camera.getPicture(
	   function(imageURI) {
	      var img = document.getElementById('camera_image');
	      img.src = imageURI;
	      $('#camera_status').html("成功照相...");
	   },
	   function(e) {
	      $('#camera_status').html("照相失敗...");
	   },
	   {  quality: 50, 
	      destinationType: Camera.DestinationType.FILE_URI
	   });
	}
	function selectPicture() {
	   navigator.camera.getPicture(
	   function(imageURI) {
	      $('#camera_image').attr('src', imageURI);
	      $('#camera_status').html("成功選擇圖片...");
	   },
	   function(e) {
	      $('#camera_status').html("選擇圖片失敗...");
	   },
	   {  quality: 50, 
	      destinationType: Camera.DestinationType.FILE_URI, 
	      sourceType: Camera.PictureSourceType.PHOTOLIBRARY
	   });
	}
	function uploadPicture() {
	   // 取得上傳圖片的URI
	   var img = document.getElementById('camera_image');
	   var imageURI = img.src;
	   if (imageURI) {  // 有圖片    
	      server = $('#serverUrl').val();  // 取得上傳網址 
	      if (server) {  // 建立FileUploadOptions物件
	         var options = new FileUploadOptions();
	         options.fileKey = "file";
	         options.fileName = imageURI.substr(imageURI.lastIndexOf('/')+1);
	         options.mimeType = "image/jpeg";
	         var params = new Object(); // 建立參數物件
	         params.id = $('#idVal').val();
	         params.text = $('#takeText').val();
	         options.params = params;
	         options.chunkedMode = false;
	         var ft = new FileTransfer();   // 上傳檔案
	         ft.upload(imageURI, server, onSuccess, onFail, options);
	      }
	   }
	   else  $('#camera_status').html("請照相或選擇圖片...");  
	}
	function onSuccess(r) {
	   $('#camera_status').html("上傳成功: " + r.bytesSent + "位元組");              
	}
	function onFail(error) {
	   $('#camera_status').html("上傳失敗: 錯誤碼 = " + error.code);             
	}	
    
    </script>
  </head>
  <body onload="onBodyLoad()">
    <div data-role="page" id="home">
    	<div data-role="content">
        	<div id="gallery" class="ui-grid-c"></div>
        	<a href="#" id="scan-button" data-role="button" data-inline="true" data-icon="arrow-r" data-iconpos="right">開始掃描</a>
        	<input name="qrname" id="qrname" type="hidden">
    		<div id="msg"></div>
    	</div>
    </div>
    <div data-role="dialog" id="eleven">
		<div data-role="header">
  		<h1>你11個燈了。</h1>
  		</div>
  		<div data-role="content">
    		<p>集滿16個燈可有infotree喔。</p>
  		</div>
	</div>
    <div data-role="dialog" id="fifteen">
		<div data-role="header">
  		<h1>你15個燈了</h1>
  		</div>
		<div data-role="content">
    		<form>
    			<p>填完資料送出即具抽獎資格喔。</p>
    			<input type="hidden" id="idVal"/>
    			<p>輸入您的名：
    			<input type="text" id="nameVal"/>
    			</p>
    			<p>輸入聯繫您的號碼：
    			<input type="number" id="phoneVal"/>
    			</p>
    			<input type="submit" value="送出">
    		</form>    
  		</div>
	</div>
    <div data-role="dialog" id="sixteen">
		<div data-role="header">
  		<h1>你16個燈了。</h1>
  		</div>
		<div data-role="content">
			<p>請打入一段話並上傳圖片，將會秀在infotree。</p>
    		<input id="serverUrl" type="hidden" value="http://ftp.daf.org.tw/upload.php"/>
      		<input type="text" id="takeText"/>
      		<input type="button" id="takePicture" value="照相"/>
      		<input type="button" id="selectPicture" value="選擇圖片"/>
      		<input type="button" id="uploadPicture" value="上傳圖片"/>
      		<div id="camera_status"></div>
      		<img style="width:200px" id="camera_image" src=""/>    
  		</div>
	</div>
  </body>
</html>