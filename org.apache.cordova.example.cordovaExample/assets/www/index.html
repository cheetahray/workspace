<!DOCTYPE html>
<html>
  <head>
  <title></title>
  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0;" />
    <meta charset="big5">

    <!-- iPad/iPhone specific css below, add after your main css >
    <link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />		
    <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />		
    -->
    <link rel="stylesheet" href="jquery.mobile.min.css">
    <script src="jquery-1.6.4.min.js"></script>
    <script src="jquery.mobile.min.js"></script>

    <!-- If your application is targeting iOS BEFORE 4.0 you MUST put json2.js from http://www.JSON.org/json2.js into your www directory and include it here -->
    <script type="text/javascript" charset="utf-8" src="cordova-1.8.1.js"></script>
    <script type="text/javascript" charset="utf-8" src="barcodescanner.js"></script>
    
    <script type="text/javascript">

    function onBodyLoad()
	{		
		document.addEventListener("deviceready", onDeviceReady, false);

        scanButton = document.getElementById("scan-button");
	}
	
    function onUpdateReady() {
        var db = window.openDatabase("Database", "1.0", "PhoneGap", 200000);
        db.transaction(updateDB, errorDB, successDB);
        db.transaction(queryDB, errorDB);
    }
        
    function createDB(tx) {
        //tx.executeSql('DROP TABLE IF EXISTS USER');
        tx.executeSql('CREATE TABLE IF NOT EXISTS USER (id unique, cRuth, hAQes, JAwra, zaqAQ, cReth, XawrE, Qeste, YEChe, StuFR, rATre, cEsap, jUfrE, fUspe, FrAst, qExet, pHare)');
    }
    
	function insertDB(tx) {
        tx.executeSql('INSERT INTO USER (id, cRuth, hAQes, JAwra, zaqAQ, cReth, XawrE, Qeste, YEChe, StuFR, rATre, cEsap, jUfrE, fUspe, FrAst, qExet, pHare) ' +
                      'VALUES (1, "on", "on", "on", "on", "on", "on", "on", "on", "on", "on", "on", "on", "on", "on", "off", "on")');
    }
        
    function updateDB(tx) {
        var setName = $("#qrname");
        tx.executeSql("UPDATE USER SET " + setName.val() + "='on' where id=1");
    }
        
    function successDB() {
        console.log("Transaction Success!");
        //alert("Transaction Success!");
    }
        
    function queryDB(tx) {
        tx.executeSql('SELECT * FROM USER', [], querySuccess, errorDB);
    }
        
    function querySuccess(tx, results) {
        var number = 0;
        var parent = $('#gallery');
        parent.html('<div class="ui-block-a">' + '<img src="images/' +
                    results.rows.item(0).cRuth + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).cRuth)
        	number++;
        parent.append('<div class="ui-block-b">' + '<img src="images/' +
                    results.rows.item(0).hAQes + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).hAQes)
        	number++;
        parent.append('<div class="ui-block-c">' + '<img src="images/' +
                      results.rows.item(0).JAwra + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).JAwra)
        	number++;
        parent.append('<div class="ui-block-d">' + '<img src="images/' +
                      results.rows.item(0).zaqAQ + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).zaqAQ)
        	number++;
        parent.append('<div class="ui-block-a">' + '<img src="images/' +
                      results.rows.item(0).cReth + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).cReth)
        	number++;
        parent.append('<div class="ui-block-b">' + '<img src="images/' +
                      results.rows.item(0).XawrE + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).XawrE)
        	number++;
        parent.append('<div class="ui-block-c">' + '<img src="images/' +
                      results.rows.item(0).Qeste + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).Qeste)
        	number++;
        parent.append('<div class="ui-block-d">' + '<img src="images/' +
                      results.rows.item(0).YEChe + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).YEChe)
        	number++;
        parent.append('<div class="ui-block-a">' + '<img src="images/' +
                      results.rows.item(0).StuFR + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).StuFR)
        	number++;
        parent.append('<div class="ui-block-b">' + '<img src="images/' +
                      results.rows.item(0).rATre + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).rATre)
        	number++;
        parent.append('<div class="ui-block-c">' + '<img src="images/' +
                      results.rows.item(0).cEsap + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).cEsap)
        	number++;
        parent.append('<div class="ui-block-d">' + '<img src="images/' +
                      results.rows.item(0).jUfrE + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).jUfrE)
        	number++;
        parent.append('<div class="ui-block-a">' + '<img src="images/' +
                      results.rows.item(0).fUspe + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).fUspe)
        	number++;
        parent.append('<div class="ui-block-b">' + '<img src="images/' +
                      results.rows.item(0).FrAst + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).FrAst)
        	number++;
        parent.append('<div class="ui-block-c">' + '<img src="images/' +
                      results.rows.item(0).qExet + '.png" height="50" width="50"/></div>');
        if("on" == results.rows.item(0).qExet)
        	number++;
        if(number >= 11)
        {
        	parent.append('<div class="ui-block-d">' + '<img src="images/' +
                      results.rows.item(0).pHare + '.png" height="50" width="50"/></div>');
        	if("on" == results.rows.item(0).pHare)
        		number++;
        }
        switch(number)
        {
        	case 11:
        		$.mobile.changePage($('#eleven'));
	        break;
        	case 15:
        		$.mobile.changePage($('#fifteen'));
        	break;
        	case 20:
        		$.mobile.changePage($('#sixteen'));
        	break;
        }
    }
        
    function errorDB(err) {
        console.log("Transaction Fail! " + err.code);
        //alert("Transaction Fail! " + err.code);
    }
        
    function onDeviceReady()
	{
		// do your thing!
		//navigator.notification.alert("PhoneGap is working");
		var db = window.openDatabase("Database", "1.0", "PhoneGap", 200000);
        db.transaction(createDB, errorDB);
        db.transaction(insertDB, errorDB, successDB);
        db.transaction(queryDB, errorDB);
        scanButton.addEventListener("click", clickScan, false);

        $("form").submit( function() {
        	var phoneVal = $('#phoneVal').val();
        	var nameVal = $('#nameVal').val();
        	if(phoneVal == ""){ 
				alert("號碼不能空著喔。"); 
			}
			else if(nameVal == ""){ 
				alert("名字不能空著喔。"); 
			}
			else
			{
        		$.ajax({
        			type: 'POST',
        			url:  'http://ftp.daf.org.tw/getNamePhone.php',
        			data: { name : nameVal,
        					phone : phoneVal }, 
        			error: function() {
           				alert("載入網頁錯誤!");
        			},        
        			success: function(data) {
           				//$('#result').html($(data).find('data').text());
           				alert("新增成功: " + $(data).find('name').text());
           				$.mobile.changePage($('#home'));    
        			} 
      			});
      		}    
      		return false;
   		});
   		
   		$('#msg').ajaxError(function(event, request, settings) {
      		$(this).html('載入網頁錯誤: ' + settings.url + '!');
   		});
   
	}

    function clickScan() {
        window.plugins.barcodeScanner.scan(scannerSuccess, scannerFailure);
    }

    //------------------------------------------------------------------------------
    function scannerSuccess(result) 
    {
        console.log("scannerSuccess: result: " + result);
        if(false == result.cancelled)
        {
            $('#qrname').val(result.text);
            onUpdateReady();
    	}
        /*
        else
        {
            alert("Ray");
        }
        */
        console.log("We got a barcode\n" +
					"Result: " + result.text + "\n" +
					"Format: " + result.format + "\n" +
					"Cancelled: " + result.cancelled);
    }

	
    //------------------------------------------------------------------------------
    function scannerFailure(message) {
        console.log("scannerFailure: message: " + message);
        //alert("Scanning failed: " + message);
	}
    
    </script>
  </head>
  <body onload="onBodyLoad()">
    <div data-role="page" id="home">
    	<div data-role="content">
        	<div id="gallery" class="ui-grid-c"></div>
        	<a href="#" id="scan-button" data-role="button" data-inline="true" data-icon="arrow-r" data-iconpos="right">開始掃描</a>
        	<input name="qrname" id="qrname" type="hidden">
    		<div id="msg"></div>
    	</div>
    </div>
    <div data-role="dialog" id="eleven">
		<div data-role="header">
  		<h1>你11個燈了。</h1>
  		</div>
  		<div data-role="content">
    		<p>集滿16個燈可有infotree喔。</p>
  		</div>
	</div>
    <div data-role="dialog" id="fifteen">
		<div data-role="header">
  		<h1>你15個燈了，具備抽獎資格。</h1>
  		</div>
		<div data-role="content">
    		<form>
    			<p>輸入您的名：
    			<input type="text" id="nameVal"/>
    			</p>
    			<p>輸入聯繫您的號碼：
    			<input type="number" id="phoneVal"/>
    			</p>
    			<input type="submit" value="送出">
    		</form>    
  		</div>
	</div>
    <div data-role="dialog" id="sixteen">
		<div data-role="header">
  		<h1>你16個燈了。</h1>
  		</div>
		<div data-role="content">
    		<p>Yeah!</p>    
  		</div>
	</div>
  </body>
</html>