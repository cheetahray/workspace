<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.2//EN" "http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0"/>
<title>數位藝術節</title>
<link href="css/reset.css" media="all" rel="stylesheet" type="text/css" />    
<link href="css/main.css" media="all" rel="stylesheet" type="text/css" />
<script src="jquery-1.6.4.min.js"></script>
<script type="text/javascript" charset="utf-8" src="cordova-1.8.1.js"></script>
    <script type="text/javascript" charset="utf-8" src="barcodescanner.js"></script>
                <script type="text/javascript" charset="utf-8" src="childbrowser.js"></script>
                <script type="text/javascript" charset="utf-8" src="FBConnect.js"></script>
                <script type="text/javascript" charset="utf-8" src="json2-min.js"></script>
     
 <script type="text/javascript">       
    var fbPlugin;
    var client_id = "293327944111580";
    var redir_url = "https://www.facebook.com/connect/login_success.html";    
    var number, delayTime;
	function onBodyLoad()
	{	
        document.addEventListener("deviceready", onDeviceReady, false);
	}
    
    function onUpdateReady() {
        updateDB();
        querySuccess();
    }
    
    function createDB() 
    {

        if (!localStorage.cRuth)
        {
                            localStorage.setItem("cRuth","");
        }
        if (!localStorage.hAQes)
        {
                            localStorage.setItem("hAQes","");
        }
        if (!localStorage.JAwra)
        {
                            localStorage.setItem("JAwra","");
        }
        if (!localStorage.zaqAQ)
        {
                            localStorage.setItem("zaqAQ","");
        }
        if (!localStorage.cReth)
        {
            localStorage.setItem("cReth","");
        }
        if (!localStorage.XawrE)
        {
                            localStorage.setItem("XawrE","");
        }
        if (!localStorage.Qeste)
        {
                            localStorage.setItem("Qeste","");
        }
        if (!localStorage.YEChe)
        {
                            localStorage.setItem("YEChe","");
        }
        if (!localStorage.StuFR)
        {
                            localStorage.setItem("StuFR","");
        }
        if (!localStorage.rATre)
        {
                            localStorage.setItem("rATre","");
        }
        if (!localStorage.cEsap)
        {
                            localStorage.setItem("cEsap","");
        }
        if (!localStorage.jUfrE)
        {
            localStorage.setItem("jUfrE","");
        }
        if (!localStorage.fUspe)
        {
            localStorage.setItem("fUspe","");
        }
        if (!localStorage.FrAst)
        {
            localStorage.setItem("FrAst","");
        }
        if (!localStorage.qExet)
        {
            localStorage.setItem("qExet","");
        }
        if (!localStorage.pHare)
        {
            localStorage.setItem("pHare","");
        }

    }
    
    function updateDB() {
        var setName = $("#qrname").val();
        if(" get" == localStorage.getItem(setName))
        {
            var raynum = $('#raynumber');
            raynum.html("重複掃描");
            delayTime = 2000;
        }
        else if("pHare" == setName) 
        {
            if(number >= 11 && "" == localStorage.getItem("pHare"))
        {
            localStorage.setItem(setName," get");
            setTimeout('delayedRedirect("upload.html")', 1000);
        }
            else
            {
                var raynum = $('#raynumber');
                raynum.html("尚未集滿11點或已傳上info tree.");
                delayTime = 2000;
            }
        }
        else
            localStorage.setItem(setName," get");
    }
    
    function querySuccess() 
    {
        number = 0;
        var parent = $('#gallery');
        if(" get" == localStorage.getItem("cRuth"))
        	number++;
        if(" get" == localStorage.getItem("hAQes"))
        	number++;
        if(" get" == localStorage.getItem("JAwra"))
        	number++;
        if(" get" == localStorage.getItem("zaqAQ"))
        	number++;
        if(" get" == localStorage.getItem("cReth"))
        	number++;
        if(" get" == localStorage.getItem("XawrE"))
        	number++;
        if(" get" == localStorage.getItem("Qeste"))
        	number++;
        if(" get" == localStorage.getItem("YEChe"))
        	number++;
        if(" get" == localStorage.getItem("StuFR"))
        	number++;
        if(" get" == localStorage.getItem("rATre"))
        	number++;
        if(" get" == localStorage.getItem("cEsap"))
        	number++;
        if(" get" == localStorage.getItem("jUfrE"))
        	number++;
        if(" get" == localStorage.getItem("fUspe"))
        	number++;
        if(" get" == localStorage.getItem("FrAst"))
        	number++;
        if(" get" == localStorage.getItem("qExet"))
        	number++;
        var ray = "";
        ray = '<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td width="25%" align="center" valign="middle" class="qr01' 
                    + localStorage.getItem("cRuth") + '"><span></span></td>';
        ray += '<td width="25%" align="center" valign="middle" class="qr02' +
                    localStorage.getItem("hAQes") + '"><span></span></td>';
        ray += '<td width="25%" align="center" valign="middle" class="qr03' +
                      localStorage.getItem("JAwra") + '"><span></span></td>';
        ray += '<td width="25%" align="center" valign="middle" class="qr04' +
                      localStorage.getItem("zaqAQ") + '"><span></span></td></tr>';
        ray += '<tr><td align="center" valign="middle" class="qr05' +
                      localStorage.getItem("cReth") + '"><span></span></td>';
        ray += '<td align="center" valign="middle" class="qr06' +
                      localStorage.getItem("XawrE") + '"><span></span></td>';
        ray += '<td align="center" valign="middle" class="qr07' +
                      localStorage.getItem("Qeste") + '"><span></span></td>';
        parent.html(ray);
        var ray2 = "";
        ray2 += '<td align="center" valign="middle" class="qr08' +
                      localStorage.getItem("YEChe") + '"><span></span></td></tr>';
        ray2 += '<tr><td align="center" valign="middle" class="qr09' +
                      localStorage.getItem("StuFR") + '"><span></span></td>';
        ray2 += '<td align="center" valign="middle" class="qr10' +
                      localStorage.getItem("rATre") + '"><span></span></td>';
        ray2 += '<td align="center" valign="middle" class="qr11' +
                      localStorage.getItem("cEsap") + '"><span></span></td>';
	ray2 += '<td align="center" valign="middle" class="qr16' +
                      localStorage.getItem("jUfrE") + '"><span></span></td></tr>';
        ray2 += '<tr><td align="center" valign="middle" class="qr13' +
                      localStorage.getItem("fUspe") + '"><span></span></td>';
        ray2 += '<td align="center" valign="middle" class="qr14' +
                      localStorage.getItem("FrAst") + '"><span></span></td>';
        ray2 += '<td align="center" valign="middle" class="qr15' +
                      localStorage.getItem("qExet") + '"><span></span></td>';
        ray2 += '<td align="center" valign="middle" class="qr12">';
        if(number >= 11)
        {
        	if("" == localStorage.getItem("pHare"))
            {
                ray2 += "快到<br/>info tree<br/>許願喔";
            }
            else
            {
                ray2 += "願望達成";
            }
        }
        else
        {
            ray2 += "加油!<br/>集滿11個<br/>即可許願";
        }              
        ray2 += '</td></tr></table>';
        parent.html(ray + ray2);
        switch(number)
        {
            case 0:
            case 1:
            case 2:
            case 3:
            case 4:
            case 5:
            case 6:
            case 7:
            case 8:
            case 9:
            case 10:
                if(0 != localStorage.getItem("settle"))
                    shareOnFaceBook("我在松山文創園區，參與2012台北數位藝術節，快來一起沿著windows 8尋找數位藝術足跡吧!", "http://ftp.daf.org.tw/fbimg.jpg", "http://digitalartfestival.tw/daf12/app.html", 0);
            break;
        	case 11:
            case 12:
            case 13:
            case 14:
                if(11 != localStorage.getItem("settle"))
                {
                    shareOnFaceBook("我在2012台北數位藝術節，已集滿11個足跡，獲得許願機會! 快來一起沿著windows 8蒐集數位藝術足跡吧!", "http://ftp.daf.org.tw/fbimg.jpg", "http://digitalartfestival.tw/daf12/app.html", 11);
	            }
            break;
        	case 15:
                if(15 != localStorage.getItem("settle"))
                {   
                setTimeout('delayedRedirect("form.html")', 500);
                }
                else
                {
                    $('#raystyle1').attr('style', "display:none;");
                    $('#raystyle2').attr('style', "");
                }
        	break;
	    }
        setTimeout('delayedStyle()', delayTime);
    }  
    
    function delayedRedirect(url){
        window.location = url;
    }

    function delayedStyle(){
        var raynum = $('#raynumber');
        raynum.html("我的數位藝術足跡：" + number);
        delayTime = 100;
    }

    function rayray(raynum)
    {
                      //console.log(evt.target.responseText);
                      switch(raynum)
                      {
                        case 0:
                            localStorage.setItem("settle", 0);
                        break;
                        case 11:
                            localStorage.setItem("settle", 11);
                            setTimeout('delayedRedirect("congrets.html")', 1500);
                        break;
                        case 15:

                        break;
                      }
    }

    function shareOnFaceBook(text, image, url, raynum) 
    {
        if (typeof(fbPlugin) === 'undefined')
        {
            fbPlugin = FBConnect.install();
        }
        fbPlugin.connect(client_id, redir_url, "touch");
        fbPlugin.onConnect = function() {
             //console.log("onFBConnected id=" + window.plugins.fbConnect.accessToken);
             var why = rayray(raynum);
             window.plugins.fbConnect.postFBWall(text, url, image, why);
        };
    }
    
    function onDeviceReady()
	{
        delayTime = 100;
        $.support.cors                 = true;
        var scanButton = document.getElementById("scan-button");
		createDB();
        scanButton.addEventListener("click", clickScan, false);
        window.plugins.barcodeScanner.scan(scannerSuccess, scannerFailure);   
	}
      
    function clickScan() 
    {
        if(number != 15 || "" == localStorage.getItem("pHare"))
        window.plugins.barcodeScanner.scan(scannerSuccess, scannerFailure);
    }                       
                            
	//------------------------------------------------------------------------------
    function scannerSuccess(result) 
    {
        if(false == result.cancelled)
        {
            $('#qrname').val(result.text);
            onUpdateReady();
    	}
        /*
        console.log("We got a barcode\n" +
                                    "Result: " + result.text + "\n" +
                                    "Cancelled: " + result.cancelled);
        */
    }
    	
    //------------------------------------------------------------------------------
    function scannerFailure(message) {
        querySuccess();
        console.log("scannerFailure: message: " + message);
	}	
</script>

</head>

<body onload="onBodyLoad()">

  
      <header style="width:100%; height:10%">
        <img src="images/logo.png" width="208"/>
        <a href="index.html" data-ajax="false" class="home"></a>  
      </header>

      <div  class="wrapper">

        <div class="scan2">
          <a href="#" id="scan-button">
            <span></span>
            <p>掃描足跡</p>
          </a>
        </div>

        <div class="rule">
          <a href="rule.html" data-ajax="false">
            <span></span>
            <p>遊戲規則</p>
          </a>
        </div>

        <div class="space"></div>
        
        <div id="raystyle1" class="info"><span id="raynumber" style="font-size:24px;"></span></div>
        <div id="raystyle2" class="info" style="display:none;"><span style="font-size:18px;">恭喜您已集滿，獲得</span><span style="font-size:24px;">抽獎機會</span></div>
        
        <div  id="gallery" class="qr">
        </div>

      </div>
      <input name="qrname" id="qrname" type="hidden">

 
</body>

</html>
